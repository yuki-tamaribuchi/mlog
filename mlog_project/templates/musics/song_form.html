{% extends 'base.html' %}
{% block title%}曲{% if object %}更新{% else %}登録{% endif %} | {{block.super}}{% endblock title %}
{% block head %}
	{{ form.media.css }}
	<style>
		input,select{width:50%}
	</style>
{% endblock head %}
{% block content %}
<div class="container">
	<div class="row mt-5">
		<form id="song_form" method="POST">
			{% csrf_token %}
			{{form.as_p}}
			<select id="spotify_track_select">
				<option selected disabled>曲を選んでください</option>
			</select>
			<input type="hidden" value="dj chari come" id="search_keywords">
			<input type="button" value="検索" id="search_btn" onclick="search()">
			<input type="submit" value="登録">
		</form>
		<a href="javascript:void(0)" onclick="window.open('{% url 'musics:artist_create_popup' %}','subwin_artist')">アーティストを追加</a>
		<a href="javascript:void(0)" onclick="window.open('{% url 'musics:genre_create_popup' %}','subwin_genre')">ジャンルを追加</a>
	</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
{{ form.media.js }}
<script>
	function add_artist(name,pk){
		var select=document.getElementById('id_artist');
		var option=document.createElement('option');
		option.setAttribute('value',pk);
		option.innerHTML=name;

		select.add(option,0);
		select.options[0].selected=true;
	}

	function add_genre(name,pk){
		var select=document.getElementById('id_genre');
		var option=document.createElement('option');
		option.setAttribute('value',pk);
		option.innerHTML=name;

		select.add(option,0);
		select.options[0].selected=true;
	}

	function getCookie(name) {
    	let cookieValue = null;
	    if (document.cookie && document.cookie !== '') {
	        const cookies = document.cookie.split(';');
	        for (let i = 0; i < cookies.length; i++) {
	            const cookie = cookies[i].trim();
	            // Does this cookie string begin with the name we want?
	            if (cookie.substring(0, name.length + 1) === (name + '=')) {
	                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
	                break;
	            }
	        }
	    }
	    return cookieValue;
	}
	const csrftoken = getCookie('csrftoken');


	function csrfSafeMethod(method){
		return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
	}

	$.ajaxSetup({
		beforeSend: function(xhr, settings){
			if (!csrfSafeMethod(settings.type) && !this.crossDomain){
				xhr.setRequestHeader("X-CSRFToken", csrftoken);
			}
		}
	});

	$('#search_btn').on('click', function(e){
		e.preventDefault();
	
		$.ajax({
			'url':'{% url "musics:search_spotify_tracks"%}',
			'type':'POST',
			'data':{
				'search_keywords':$('#search_keywords').val()
			},
			'dataType':'json'
		})
		.done(function(response){
			$('.result').prepend('');
		});
	});

	function search(){
		$.ajax({
			'url':'{% url "musics:search_spotify_tracks"%}',
			'type':'POST',
			'data':{
				'search_keywords':$('#search_keywords').val()
			},
			'dataType':'json'
		})
		.done(function(response){
			console.log(response['results']);
			results = response['results'];
			let html_data = '<option value="">--------</option>';
			results.forEach(function(result){
				html_data += `<option vlaue="${result.preview_url}">${result.track_name}/${result.artists}</option>`
			});
			console.log(html_data);
			$("#spotify_track_select").html(html_data);
		});
	}
</script>
{% endblock content %}