{% extends 'base.html' %}
{% block title%}Spotifyでトラックを選択 | {{block.super}}{% endblock title %}
{% block content %}
<div class="container">
	<div class "row mt-5">
		<form action="{% url 'musics:select_spotify_tracks' %}" method="POST">
			{% csrf_token %}
			<p>
				<label>Spotify track search:</label>
				<input type="search" id="search_keywords">
				<input type="button" value="検索" onclick="search()">
				<select id="spotify_track_select"  name="selected_track">
					<option selected disabled>曲を選んでください</option>
				</select>
			</p>
			<input type="submit" value="送信">
		</form>
	</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
	function getCookie(name) {
    	let cookieValue = null;
	    if (document.cookie && document.cookie !== '') {
	        const cookies = document.cookie.split(';');
	        for (let i = 0; i < cookies.length; i++) {
	            const cookie = cookies[i].trim();
	            // Does this cookie string begin with the name we want?
	            if (cookie.substring(0, name.length + 1) === (name + '=')) {
	                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
	                break;
	            }
	        }
	    }
	    return cookieValue;
	}
	const csrftoken = getCookie('csrftoken');


	function csrfSafeMethod(method){
		return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
	}

	$.ajaxSetup({
		beforeSend: function(xhr, settings){
			if (!csrfSafeMethod(settings.type) && !this.crossDomain){
				xhr.setRequestHeader("X-CSRFToken", csrftoken);
			}
		}
	});


	function search(){
		$.ajax({
			'url':'{% url "musics:search_spotify_tracks"%}',
			'type':'POST',
			'data':{
				'search_keywords':$('#search_keywords').val()
			},
			'dataType':'json'
		})
		.done(function(response){
			console.log(response['results']);
			results = response['results'];
			let html_data = '<option value="">--------</option>';
			results.forEach(function(result){
				html_data += `<option value="${result.preview_url}">${result.track_name}/${result.artists}</option>`
			});
			$("#spotify_track_select").html(html_data);
		});
	}
</script>
{% endblock content %}